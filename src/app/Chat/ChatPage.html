<div class="app-content">
  <div class="chat-body" (click)="closeAllMenu(); closeHeaderMenu()">
    <ng-container *ngIf="!loading; else loadingTpl">
      <div class="messages-container" #messagesContainer (click)="$event.stopPropagation()">
        <ng-container *ngFor="let msg of messages; let i = index">
          <div
            class="day-separator"
            *ngIf="
              i === 0 || formatDayLabel(messages[i - 1].createdAt) !== formatDayLabel(msg.createdAt)
            "
          >
            <span>{{ formatDayLabel(msg.createdAt) }}</span>
          </div>

          <!-- Message bubble -->
          <div class="message" [class.mine]="isMine(msg)">
            <div class="message-header">
              <span class="sender" *ngIf="!isMine(msg)">{{ msg.senderNick || msg.sender }}</span>
              <span class="time">{{ formatTime(msg.createdAt) }}</span>
            </div>

            <!-- Standort -->
            <div class="content" *ngIf="msg.content">
              <ng-container *ngIf="isLocationLink(msg.content); else normalText">
                <a class="location-card" [href]="msg.content" target="_blank" rel="noopener">
                  <div class="location-thumb-wrap">
                    <img
                      class="location-thumb"
                      [src]="getStaticMapUrl(msg.content) || ''"
                      alt="Standort Vorschau"
                    />
                    <div class="location-pin"></div>
                  </div>
                  <div class="location-meta">
                    <div class="location-title">Aktueller Standort</div>
                    <div class="location-sub">Zum Öffnen tippen</div>
                  </div>
                </a>
              </ng-container>

              <ng-template #normalText>
                {{ msg.content }}
              </ng-template>
            </div>

            <!-- Image -->
            <img
              *ngIf="msg.imageUrl"
              [src]="msg.imageUrl"
              alt="Bild"
              class="image-message"
              (load)="onMessageImageLoaded()"
              (error)="onMessageImageLoaded()"
            />
          </div>
        </ng-container>
        <div #bottomAnchor></div>
      </div>
    </ng-container>

    <!-- Kamera Popup -->
    <div class="camera-overlay" *ngIf="cameraModalOpen" (click)="closeCameraModal()">
      <div class="camera-sheet" (click)="$event.stopPropagation()">
        <div class="camera-sheet-header">
          <button type="button" class="sheet-close" (click)="closeCameraModal()">✕</button>
          <div class="sheet-title">Kamera</div>
          <div class="sheet-spacer"></div>
        </div>

        <div class="camera-sheet-content">
          <video #video autoplay playsinline muted [hidden]="!!previewUrl"></video>

          <img *ngIf="previewUrl" [src]="previewUrl" class="sheet-preview" alt="Foto Vorschau" />

          <canvas #canvas hidden></canvas>
        </div>

        <div class="camera-sheet-actions">
          <button type="button" *ngIf="streamActive && !previewUrl" (click)="takePhoto()">
            Foto machen
          </button>

          <button type="button" *ngIf="previewUrl" (click)="removePhoto()">Entfernen</button>

          <button type="button" class="primary" *ngIf="previewUrl" (click)="sendMessage()">
            Senden
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Footer -->
<div class="chat-footer" (click)="$event.stopPropagation()">
  <div class="footer-grid">
    <!-- Links: Menü -->
    <div class="footer-left">
      <div class="actions-wrap">
        <button type="button" class="actions-btn" (click)="toggleAllMenu()">+</button>

        <div class="actions-menu" *ngIf="showAllMenu">
          <button type="button" (click)="onMenuFile()">Datei</button>
          <button type="button" (click)="onMenuCamera()">Kamera</button>
          <button type="button" (click)="onMenuLocation()" [disabled]="locationLoading">
            Standort
          </button>
        </div>

        <input #fileInput type="file" accept="image/png" hidden (change)="onFileSelected($event)" />
      </div>
    </div>

    <!-- Mitte: Input -->
    <div class="footer-middle">
      <input
        type="text"
        [(ngModel)]="newMessage"
        placeholder="Nachricht schreiben..."
        (keyup.enter)="sendMessage()"
      />
    </div>

    <!-- Rechts: Send -->
    <div class="footer-right">
      <button type="button" class="send-btn" (click)="sendMessage()">
        <img src="/icons/paper-plane.svg" class="send-icon" alt="" aria-hidden="true" />
      </button>
    </div>
  </div>
</div>

<ng-template #loadingTpl>
  <div>Loading messages...</div>
</ng-template>
