<div class="chat-detail">
  <div *ngIf="!loading; else loadingTpl"></div>

  <!-- Optional: Aktionen direkt unter dem globalen Header -->
  <div class="chat-actions">
    <button class="leave-btn" *ngIf="!isOwner" (click)="leaveChat()">Chat verlassen</button>
    <button class="leave-btn" *ngIf="isOwner" (click)="deleteChat()">Chat lÃ¶schen</button>
  </div>

  <div class="messages-container" #messagesContainer>
    <ng-container *ngFor="let msg of messages; let i = index">
      <div
        class="day-separator"
        *ngIf="
          i === 0 || formatDayLabel(messages[i - 1].createdAt) !== formatDayLabel(msg.createdAt)
        "
      >
        <span>{{ formatDayLabel(msg.createdAt) }}</span>
      </div>

      <div class="message" [class.mine]="isMine(msg)">
        <div class="message-header">
          <span class="sender" *ngIf="!isMine(msg)">{{ msg.sender }}</span>
          <span class="time">{{ formatTime(msg.createdAt) }}</span>
        </div>

        <div class="content" *ngIf="msg.content">
          <ng-container *ngIf="isLocationLink(msg.content); else normalText">
            <a class="location-card" [href]="msg.content" target="_blank" rel="noopener">
              <div class="location-thumb-wrap">
                <img
                  class="location-thumb"
                  [src]="getStaticMapUrl(msg.content) || ''"
                  alt="Standort Vorschau"
                />
                <div class="location-pin"></div>
              </div>
              <div class="location-meta">
                <div class="location-title">Aktueller Standort</div>
                <div class="location-sub">Zum Ã–ffnen tippen</div>
              </div>
            </a>
          </ng-container>

          <ng-template #normalText>
            {{ msg.content }}
          </ng-template>
        </div>

        <img
          *ngIf="msg.imageUrl"
          [src]="msg.imageUrl"
          alt="Bild"
          class="image-message"
          (load)="onMessageImageLoaded()"
          (error)="onMessageImageLoaded()"
        />
      </div>
    </ng-container>
  </div>

  <div class="message-input">
    <div *ngIf="showPhotoContainer" class="photo-container">
      <video #video autoplay playsinline class="camera-preview" [hidden]="!streamActive"></video>
      <canvas #canvas hidden></canvas>

      <img *ngIf="previewUrl" [src]="previewUrl" alt="Foto Vorschau" class="photo-preview" />
    </div>

    <div class="camera-buttons">
      <input #fileInput type="file" accept="image/png" hidden (change)="onFileSelected($event)" />

      <button type="button" (click)="fileInput.click()">ğŸ”—</button>

      <button *ngIf="!streamActive && !previewUrl" type="button" (click)="openCamera()">ğŸ“·</button>
      <button *ngIf="streamActive" type="button" (click)="takePhoto()">ğŸ“¸ Foto machen</button>
      <button *ngIf="streamActive" type="button" (click)="stopCamera()">âœ– Kamera stoppen</button>
      <button *ngIf="previewUrl" type="button" (click)="removePhoto()">ğŸ—‘ Foto entfernen</button>

      <button type="button" (click)="shareCurrentLocation()" [disabled]="locationLoading">
        ğŸ“
      </button>
    </div>

    <input
      type="text"
      [(ngModel)]="newMessage"
      placeholder="Nachricht schreiben..."
      (keyup.enter)="sendMessage()"
    />

    <button type="button" (click)="sendMessage()">â¤</button>
  </div>

  <ng-template #loadingTpl>
    <div>Loading messages...</div>
  </ng-template>
</div>
